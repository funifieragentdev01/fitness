<div id="plans" class="screen has-nav">
    <div class="screen-header">
        <button class="btn-back" ng-click="goTo('profile')"><i class="fas fa-arrow-left"></i></button>
        <h2>Planos</h2>
    </div>
    <div class="screen-body">
        <div class="alert alert-success" ng-if="success">{{success}}</div>
        <div class="alert alert-danger" ng-if="error">{{error}}</div>

        <div class="sandbox-badge" ng-if="envLabel">
            <span>{{envLabel}}</span>
        </div>

        <!-- Current Plan Status Card -->
        <div class="plan-status-card" ng-if="hasSubscription">
            <div class="plan-status-header">
                <span class="plan-status-icon">{{isPremium ? 'üëë' : '‚≠ê'}}</span>
                <div class="plan-status-info">
                    <h3>{{isPremium ? 'Premium' : 'Standard'}}</h3>
                    <span class="plan-status-badge" ng-class="planStatusClass">{{planStatusLabel}}</span>
                </div>
            </div>
            <div class="plan-status-details">
                <div class="plan-status-row" ng-if="subStatus.nextDueDate && planStatus === 'active'">
                    <span>Pr√≥xima cobran√ßa</span>
                    <span>{{formatDate(subStatus.nextDueDate)}}</span>
                </div>
                <div class="plan-status-row" ng-if="subStatus.value && planStatus === 'active'">
                    <span>Valor</span>
                    <span>R$ {{subStatus.value | number:2}}/m√™s</span>
                </div>
                <div class="plan-status-row" ng-if="planStatus === 'canceled' && planEndDate">
                    <span>Acesso at√©</span>
                    <span class="text-warning">{{formatDate(planEndDate)}}</span>
                </div>
                <div class="plan-status-row" ng-if="planStatus === 'pending_downgrade' && downgradeDate">
                    <span>Downgrade em</span>
                    <span class="text-warning">{{formatDate(downgradeDate)}}</span>
                </div>
            </div>

            <!-- Management Actions -->
            <div class="plan-management-actions">
                <!-- Downgrade (Premium only, active) -->
                <button class="btn btn-outline btn-block btn-sm" ng-if="isPremium && planStatus === 'active'"
                        ng-click="confirmDowngrade()" ng-disabled="actionLoading">
                    <i class="fas fa-arrow-down"></i> Mudar para Standard
                </button>
                <!-- Cancel (active or pending_downgrade) -->
                <button class="btn btn-outline btn-block btn-sm btn-danger-outline"
                        ng-if="planStatus === 'active' || planStatus === 'pending_downgrade'"
                        ng-click="confirmCancel()" ng-disabled="actionLoading">
                    <i class="fas fa-times"></i> Cancelar assinatura
                </button>
                <!-- Reactivate (canceled) -->
                <button class="btn btn-primary btn-block" ng-if="planStatus === 'canceled'"
                        ng-click="showReactivate = true" ng-disabled="actionLoading">
                    <i class="fas fa-redo"></i> Reativar assinatura
                </button>
            </div>
            <p class="plan-management-note" ng-if="actionLoading">
                <i class="fas fa-spinner fa-spin"></i> Processando...
            </p>
        </div>

        <!-- Reactivation Plan Selection -->
        <div class="reactivate-section" ng-if="showReactivate">
            <h3>Reativar Assinatura</h3>
            <p class="reactivate-note">Escolha seu plano para reativar. 7 dias gr√°tis inclu√≠dos!</p>
            <div class="reactivate-options">
                <button class="btn btn-primary btn-block" ng-click="reactivate('standard')" ng-disabled="actionLoading">
                    Reativar Standard ‚≠ê ‚Äî R$ 29,90/m√™s
                </button>
                <button class="btn btn-primary btn-block btn-premium" ng-click="reactivate('premium')" ng-disabled="actionLoading">
                    Reativar Premium üëë ‚Äî R$ 179,90/m√™s
                </button>
                <button class="btn btn-outline btn-block btn-sm" ng-click="showReactivate = false">Voltar</button>
            </div>
        </div>

        <!-- Coupon Section -->
        <div class="coupon-section" ng-if="!hasSubscription || showReactivate">
            <div class="coupon-input-row">
                <input type="text" class="coupon-input" ng-model="couponCode"
                       placeholder="Tem um cupom? Digite aqui"
                       ng-disabled="couponValid"
                       ng-keyup="$event.keyCode === 13 && validateCoupon()">
                <button class="btn btn-sm coupon-btn" ng-click="validateCoupon()"
                        ng-if="!couponValid" ng-disabled="checkingCoupon || !couponCode">
                    {{checkingCoupon ? '...' : 'Aplicar'}}
                </button>
                <button class="btn btn-sm coupon-btn-clear" ng-click="clearCoupon()" ng-if="couponValid">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="coupon-result coupon-success" ng-if="couponValid">
                <i class="fas fa-check-circle"></i> {{couponInfo.description}}
            </div>
            <div class="coupon-result coupon-error" ng-if="couponValid === false">
                <i class="fas fa-times-circle"></i> {{couponError}}
            </div>
        </div>

        <!-- Plan Cards (show when no subscription or choosing new) -->
        <div class="plans-container" ng-if="!hasSubscription">
            <!-- Standard Card -->
            <div class="plan-card" ng-class="{'plan-active': !isPremium}">
                <div class="plan-badge" ng-if="!isPremium && hasSubscription">Plano Atual</div>
                <div class="plan-header">
                    <h3>‚≠ê Standard</h3>
                    <div class="plan-price">
                        <span class="price-old" ng-if="hasDiscount('standard')">R$ {{getOriginalPrice('standard') | number:2}}</span>
                        <span class="price-value">R$ {{getPrice('standard') | number:2}}</span>
                        <span class="price-period">/m√™s</span>
                    </div>
                </div>
                <ul class="plan-features">
                    <li><i class="fas fa-check"></i> Plano alimentar personalizado por IA</li>
                    <li><i class="fas fa-check"></i> Plano de treino personalizado por IA</li>
                    <li><i class="fas fa-check"></i> 1 altera√ß√£o de plano por m√™s</li>
                    <li><i class="fas fa-check"></i> 1 check-in corporal por m√™s</li>
                    <li><i class="fas fa-check"></i> 1 an√°lise de laudo por m√™s</li>
                    <li><i class="fas fa-check"></i> Controle de √°gua e refei√ß√µes</li>
                    <li><i class="fas fa-check"></i> Desafio 90 Dias</li>
                    <li class="feature-disabled"><i class="fas fa-times"></i> Coach IA 24/7</li>
                    <li class="feature-disabled"><i class="fas fa-times"></i> Suporte priorit√°rio</li>
                </ul>
                <button class="btn btn-block btn-primary" ng-click="selectPlan('standard')" ng-disabled="loading">
                    {{loading ? 'Processando...' : 'Assinar Standard ‚≠ê'}}
                </button>
            </div>

            <!-- Premium Card -->
            <div class="plan-card plan-premium" ng-class="{'plan-active': isPremium}">
                <div class="plan-badge premium-badge" ng-if="isPremium && hasSubscription">Plano Atual üëë</div>
                <div class="plan-badge premium-badge" ng-if="!isPremium">Recomendado</div>
                <div class="plan-header">
                    <h3>üëë Premium</h3>
                    <div class="plan-price">
                        <span class="price-old" ng-if="hasDiscount('premium')">R$ {{getOriginalPrice('premium') | number:2}}</span>
                        <span class="price-value premium-price">R$ {{getPrice('premium') | number:2}}</span>
                        <span class="price-period">/m√™s</span>
                    </div>
                </div>
                <ul class="plan-features">
                    <li><i class="fas fa-check"></i> Tudo do Standard, mais:</li>
                    <li><i class="fas fa-check"></i> Altera√ß√µes <strong>ilimitadas</strong> de planos</li>
                    <li><i class="fas fa-check"></i> Check-ins corporais <strong>ilimitados</strong></li>
                    <li><i class="fas fa-check"></i> An√°lises de laudos <strong>ilimitadas</strong></li>
                    <li><i class="fas fa-check"></i> Coach IA personalizado 24/7</li>
                    <li><i class="fas fa-check"></i> Suporte priorit√°rio</li>
                </ul>
                <button class="btn btn-block btn-primary btn-premium" ng-click="selectPlan('premium')" ng-disabled="isPremium || loading">
                    {{isPremium ? 'Plano Atual üëë' : (loading ? 'Processando...' : 'Assinar Premium üëë')}}
                </button>
            </div>
        </div>

        <div class="plans-payment-info">
            <p><i class="fas fa-shield-alt"></i> Pagamento seguro via Asaas</p>
            <p><i class="fab fa-pix"></i> Pix ‚Ä¢ <i class="fas fa-credit-card"></i> Cart√£o ‚Ä¢ <i class="fas fa-barcode"></i> Boleto</p>
        </div>

        <p class="plans-footer">7 dias gr√°tis ‚Ä¢ Cancele quando quiser</p>
    </div>
    <bottom-nav active="'profile'"></bottom-nav>
</div>
