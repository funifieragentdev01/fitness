<div id="onboarding" class="screen onboarding-screen">
    <div class="onboarding-content">
        <div class="onboarding-progress">
            <div class="onboarding-progress-bar">
                <div class="progress-fill" ng-style="{'width': ((onboardingStep / onboardingTotalSteps) * 100) + '%'}"></div>
            </div>
            <span class="onboarding-step-label">Passo {{onboardingStep}} de {{onboardingTotalSteps}}</span>
        </div>

        <!-- Step 1: Basic Data -->
        <div ng-if="onboardingStep === 1" class="onboarding-step">
            <h2>Sobre vocÃª ğŸ§‘</h2>
            <p class="step-desc">Bora se conhecer? Conta um pouco sobre vocÃª</p>
            <div class="form-group">
                <label>Sexo</label>
                <div class="option-list horizontal">
                    <div class="option-card small" ng-class="{'active': onboarding.sex === 'M'}" ng-click="onboarding.sex = 'M'"><span>ğŸ‘¨</span><span>Masculino</span></div>
                    <div class="option-card small" ng-class="{'active': onboarding.sex === 'F'}" ng-click="onboarding.sex = 'F'"><span>ğŸ‘©</span><span>Feminino</span></div>
                </div>
            </div>
            <div class="form-group"><label>Idade</label><input type="number" ng-model="onboarding.age" placeholder="Ex: 30" min="14" max="99"></div>
            <div class="form-group"><label>Altura (cm)</label><input type="number" ng-model="onboarding.height" placeholder="Ex: 175" min="100" max="250"></div>
            <div class="form-group"><label>Peso (kg)</label><input type="number" ng-model="onboarding.weight" placeholder="Ex: 80" min="30" max="300" step="0.1"></div>
            <div class="form-group">
                <label>Qual seu objetivo?</label>
                <div class="option-list">
                    <div class="option-card" ng-class="{'active': onboarding.goal === 'perder_peso'}" ng-click="onboarding.goal = 'perder_peso'"><span class="option-icon">ğŸ”¥</span><span>Perder peso</span></div>
                    <div class="option-card" ng-class="{'active': onboarding.goal === 'ganhar_massa'}" ng-click="onboarding.goal = 'ganhar_massa'"><span class="option-icon">ğŸ’ª</span><span>Ganhar massa</span></div>
                    <div class="option-card" ng-class="{'active': onboarding.goal === 'saude'}" ng-click="onboarding.goal = 'saude'"><span class="option-icon">â¤ï¸</span><span>SaÃºde geral</span></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Meal Routine -->
        <div ng-if="onboardingStep === 2" class="onboarding-step">
            <h2>Rotina Alimentar ğŸ½ï¸</h2>
            <p class="step-desc">Em quais horÃ¡rios vocÃª costuma comer?</p>
            <div class="meal-routine-list">
                <div class="meal-routine-item" ng-repeat="meal in onboarding.meal_routine">
                    <div class="meal-routine-header">
                        <label class="toggle-label"><input type="checkbox" ng-model="meal.enabled"><span>{{meal.label}}</span></label>
                        <input type="time" ng-model="meal.time" ng-if="meal.enabled" class="time-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Diet Preferences & Budget -->
        <div ng-if="onboardingStep === 3" class="onboarding-step">
            <h2>AlimentaÃ§Ã£o ğŸ¥—</h2>
            <p class="step-desc">Suas preferÃªncias e orÃ§amento</p>
            <div class="form-group">
                <label>RestriÃ§Ãµes alimentares</label>
                <div class="chip-group">
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('nenhuma') > -1}" ng-click="toggleRestriction('nenhuma')">Nenhuma</span>
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('vegetariano') > -1}" ng-click="toggleRestriction('vegetariano')">Vegetariano</span>
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('vegano') > -1}" ng-click="toggleRestriction('vegano')">Vegano</span>
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('sem_lactose') > -1}" ng-click="toggleRestriction('sem_lactose')">Sem lactose</span>
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('sem_gluten') > -1}" ng-click="toggleRestriction('sem_gluten')">Sem glÃºten</span>
                    <span class="chip" ng-class="{'active': onboarding.restrictions.indexOf('low_carb') > -1}" ng-click="toggleRestriction('low_carb')">Low carb</span>
                </div>
            </div>
            <div class="form-group">
                <label>OrÃ§amento mensal pra alimentaÃ§Ã£o</label>
                <div class="option-list horizontal">
                    <div class="option-card small" ng-class="{'active': onboarding.budget === 'low'}" ng-click="onboarding.budget = 'low'"><span>ğŸ’°</span><span>EconÃ´mico</span></div>
                    <div class="option-card small" ng-class="{'active': onboarding.budget === 'medium'}" ng-click="onboarding.budget = 'medium'"><span>ğŸ’°ğŸ’°</span><span>Moderado</span></div>
                    <div class="option-card small" ng-class="{'active': onboarding.budget === 'high'}" ng-click="onboarding.budget = 'high'"><span>ğŸ’°ğŸ’°ğŸ’°</span><span>Sem limite</span></div>
                </div>
            </div>
        </div>

        <!-- Step 4: Training Days & Time -->
        <div ng-if="onboardingStep === 4" class="onboarding-step">
            <h2>Dias de Treino ğŸ—“ï¸</h2>
            <p class="step-desc">Quais dias da semana vocÃª vai treinar?</p>
            <div class="training-days-grid">
                <div class="day-toggle" ng-repeat="day in weekDays" ng-class="{'active': onboarding.training_days.indexOf(day.id) > -1}" ng-click="toggleTrainingDay(day.id)">{{day.short}}</div>
            </div>
            <div class="form-group" style="margin-top:20px">
                <label>HorÃ¡rio do treino</label>
                <input type="time" ng-model="onboarding.training_time" class="time-input full-width">
            </div>
        </div>

        <!-- Step 5: Training Space & Equipment -->
        <div ng-if="onboardingStep === 5" class="onboarding-step">
            <h2>Local de Treino ğŸ‹ï¸</h2>
            <p class="step-desc">Onde e com o que vocÃª treina?</p>
            <div class="option-list">
                <div class="option-card" ng-class="{'active': onboarding.equipment === 'none'}" ng-click="onboarding.equipment = 'none'"><span class="option-icon">ğŸ </span><span>Nenhum (peso corporal)</span></div>
                <div class="option-card" ng-class="{'active': onboarding.equipment === 'basic'}" ng-click="onboarding.equipment = 'basic'"><span class="option-icon">ğŸ”§</span><span>BÃ¡sico (halteres, elÃ¡sticos)</span></div>
                <div class="option-card" ng-class="{'active': onboarding.equipment === 'gym'}" ng-click="onboarding.equipment = 'gym'"><span class="option-icon">ğŸ‹ï¸</span><span>Academia completa</span></div>
            </div>
            <div class="form-group" style="margin-top:20px">
                <label>Foto do seu espaÃ§o de treino (opcional)</label>
                <div class="photo-upload-area small" ng-click="triggerSpacePhoto()">
                    <img ng-if="onboarding.space_photo" ng-src="{{onboarding.space_photo}}" class="meal-preview">
                    <div ng-if="!onboarding.space_photo" class="photo-placeholder"><i class="fas fa-camera fa-2x"></i><p>Tirar foto do espaÃ§o</p></div>
                    <input type="file" id="spacePhotoInput" accept="image/*" capture="environment" style="display:none" onchange="angular.element(this).scope().onSpacePhoto(this)">
                </div>
            </div>
        </div>

        <!-- Step 6: Body Photos -->
        <div ng-if="onboardingStep === 6" class="onboarding-step">
            <h2>Fotos Corporais ğŸ“¸</h2>
            <p class="step-desc">Tire fotos de frente e de lado para acompanhar sua evoluÃ§Ã£o (opcional)</p>
            <div class="body-photos-grid">
                <div class="body-photo-box">
                    <label>Frente</label>
                    <div class="photo-upload-area small" ng-click="triggerBodyPhoto('front')">
                        <img ng-if="onboarding.body_photo_front" ng-src="{{onboarding.body_photo_front}}" class="meal-preview">
                        <div ng-if="!onboarding.body_photo_front" class="photo-placeholder"><i class="fas fa-person fa-2x"></i><p>Frente</p></div>
                    </div>
                </div>
                <div class="body-photo-box">
                    <label>Lateral</label>
                    <div class="photo-upload-area small" ng-click="triggerBodyPhoto('side')">
                        <img ng-if="onboarding.body_photo_side" ng-src="{{onboarding.body_photo_side}}" class="meal-preview">
                        <div ng-if="!onboarding.body_photo_side" class="photo-placeholder"><i class="fas fa-person fa-2x"></i><p>Lateral</p></div>
                    </div>
                </div>
            </div>
            <input type="file" id="bodyPhotoFrontInput" accept="image/*" capture="environment" style="display:none" onchange="angular.element(this).scope().onBodyPhoto('front', this)">
            <input type="file" id="bodyPhotoSideInput" accept="image/*" capture="environment" style="display:none" onchange="angular.element(this).scope().onBodyPhoto('side', this)">
            <button class="btn btn-outline btn-block btn-sm" ng-if="(onboarding.body_photo_front || onboarding.body_photo_side) && !onboardingAnalysisResult && !onboardingAnalyzing" ng-click="analyzeOnboardingPhotos()" style="margin-top:12px">ğŸ”¬ Analisar composiÃ§Ã£o corporal</button>
            <div ng-if="onboardingAnalyzing" class="loading-box" style="margin-top:12px"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Analisando com IA...</p></div>
            <div class="analysis-result-box" ng-if="onboardingAnalysisResult" style="margin-top:12px"><div ng-bind-html="formatAnalysis(onboardingAnalysisResult)"></div></div>
            <p class="step-hint">VocÃª pode pular e adicionar depois no perfil</p>
        </div>

        <!-- Step 7: AI Goal Setting -->
        <div ng-if="onboardingStep === 7" class="onboarding-step">
            <h2>Sua Meta Personalizada ğŸ¯</h2>
            <p class="step-desc">Com base nos seus dados, aqui estÃ¡ uma meta profissional:</p>
            <div ng-if="goalLoading" class="loading-box"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Calculando sua meta ideal...</p></div>
            <div ng-if="aiGoal && !goalLoading" class="goal-card">
                <div class="goal-icon">ğŸ¯</div>
                <div class="goal-main" ng-bind-html="formatAnalysis(aiGoal.summary)"></div>
                <div class="goal-details" ng-if="aiGoal.target_weight || aiGoal.target_bf">
                    <div class="goal-detail-item" ng-if="aiGoal.target_weight"><span class="goal-detail-label">Peso meta</span><span class="goal-detail-value">{{aiGoal.target_weight}} kg</span></div>
                    <div class="goal-detail-item" ng-if="aiGoal.target_bf"><span class="goal-detail-label">% gordura meta</span><span class="goal-detail-value">{{aiGoal.target_bf}}%</span></div>
                    <div class="goal-detail-item" ng-if="aiGoal.timeline"><span class="goal-detail-label">Prazo estimado</span><span class="goal-detail-value">{{aiGoal.timeline}}</span></div>
                </div>
                <div class="goal-tip" ng-if="aiGoal.tip"><i class="fas fa-lightbulb"></i> {{aiGoal.tip}}</div>
            </div>
            <div class="goal-adjust" ng-if="aiGoal && !goalLoading">
                <p class="step-hint">Quer ajustar? Diga o que gostaria de mudar:</p>
                <textarea ng-model="goalForm.feedback" placeholder="Ex: meu objetivo Ã© longevidade e quero reduzir gordura, nÃ£o aumentar..." rows="3" class="adjust-input"></textarea>
                <button class="btn btn-outline btn-block btn-sm" ng-click="adjustGoal()" ng-disabled="!goalForm.feedback || goalLoading" style="margin-top:8px">
                    <span ng-if="!goalLoading">Ajustar meta ğŸ”„</span>
                    <span ng-if="goalLoading"><i class="fas fa-spinner fa-spin"></i></span>
                </button>
            </div>
        </div>

        <!-- Step 8: Generating Plans -->
        <div ng-if="onboardingStep === 8" class="onboarding-step generating-step">
            <div class="generating-animation">
                <div class="generating-icon"><i class="fas fa-spinner fa-spin fa-3x"></i></div>
                <h2>Gerando seus planos...</h2>
                <p class="motivational-msg">{{generatingMessage}}</p>
                <div class="generating-progress"><div class="progress-bar"><div class="progress-fill generating-fill" ng-style="{'width': generatingProgress + '%'}"></div></div></div>
            </div>
        </div>

        <!-- Step 9: Plans Preview -->
        <div ng-if="onboardingStep === 9" class="onboarding-step">
            <h2>Seus Planos EstÃ£o Prontos! ğŸ‰</h2>
            <p class="step-desc">Olha sÃ³ o que preparamos pra vocÃª</p>
            <div class="plan-preview-card">
                <h3>ğŸ½ï¸ Plano Alimentar DiÃ¡rio</h3>
                <div class="plan-preview-list">
                    <div class="plan-preview-item" ng-repeat="meal in mealPlan.meals"><span class="plan-time">{{meal.time}}</span><span class="plan-meal-name">{{meal.name}}</span></div>
                </div>
                <div class="plan-total" ng-if="mealPlan.total_calories">Total: ~{{mealPlan.total_calories}} kcal/dia</div>
            </div>
            <div class="plan-preview-card" style="margin-top:16px">
                <h3>ğŸ’ª Plano de Treino</h3>
                <div class="plan-preview-list">
                    <div class="plan-preview-item" ng-repeat="day in workoutPlan.days"><span class="plan-time">{{day.day_name}}</span><span class="plan-meal-name">{{day.muscle_group || 'Descanso ğŸ§˜'}}</span></div>
                </div>
            </div>
        </div>

        <!-- Step 10: 90-Day Challenge Offer -->
        <div ng-if="onboardingStep === 10" class="onboarding-step">
            <div class="challenge-onboard-offer">
                <div class="challenge-hero-icon">ğŸ†</div>
                <h2>Desafio 90 Dias</h2>
                <p class="step-desc">Quer acelerar sua transformaÃ§Ã£o? Comprometa-se com o desafio de 90 dias!</p>
                <div class="challenge-benefits-list">
                    <div class="challenge-benefit"><i class="fas fa-camera"></i> Fotos de progresso (dia 0, 30, 60, 90)</div>
                    <div class="challenge-benefit"><i class="fas fa-chart-line"></i> Acompanhamento de peso e medidas</div>
                    <div class="challenge-benefit"><i class="fas fa-share-alt"></i> Convide amigos para o desafio</div>
                    <div class="challenge-benefit"><i class="fas fa-medal"></i> Conquista especial ao completar</div>
                </div>
            </div>
        </div>

        <div class="onboarding-actions" ng-if="onboardingStep !== 8">
            <button class="btn btn-outline" ng-if="onboardingStep > 1 && onboardingStep < 9 && !redefineGoalMode" ng-click="prevOnboardingStep()">Voltar</button>
            <button class="btn btn-outline" ng-if="redefineGoalMode && onboardingStep === 7" ng-click="goTo('profile')">Cancelar</button>
            <button class="btn btn-primary" ng-if="onboardingStep < 6" ng-click="nextOnboardingStep()" ng-disabled="!canAdvanceOnboarding()">PrÃ³ximo</button>
            <button class="btn btn-primary" ng-if="onboardingStep === 6" ng-click="generateAIGoal()">
                <span ng-if="!loading">Definir minha meta ğŸ¯</span>
                <span ng-if="loading"><i class="fas fa-spinner fa-spin"></i></span>
            </button>
            <button class="btn btn-primary" ng-if="onboardingStep === 7 && aiGoal && !goalLoading && !redefineGoalMode" ng-click="startGeneratingPlans()">Gerar meus planos! ğŸš€</button>
            <button class="btn btn-primary" ng-if="onboardingStep === 7 && aiGoal && !goalLoading && redefineGoalMode" ng-click="saveGoalAndReturn()">Salvar Meta âœ…</button>
            <button class="btn btn-primary btn-block" ng-if="onboardingStep === 9" ng-click="completeOnboarding()">Bora comeÃ§ar! ğŸš€</button>
        </div>
    </div>
</div>
